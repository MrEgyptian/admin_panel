{% extends "base.html" %}
{% block title %}Admin Accounts{% endblock %}
{% block content %}
<div class="card">
    <div class="page-head">
        <div>
            <h2 style="margin: 0;">Administrators</h2>
            <p class="muted" style="margin: 0.35rem 0 0 0;">Assign roles and fine-grained permissions to control access.</p>
        </div>
        <a class="button-link" href="{{ url_for('settings.settings_index') }}">Settings</a>
    </div>

    {% if admins %}
    <table>
        <thead>
            <tr>
                <th>Username</th>
                <th>Role</th>
                <th>Permissions</th>
                <th>Created</th>
                <th style="width: 140px;">Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for admin in admins %}
            <tr>
                <td>{{ admin.username }}</td>
                <td>{{ admin.role_label }}</td>
                <td>
                    {% if admin.permissions_display %}
                        {{ admin.permissions_display | join(', ') }}
                    {% else %}
                        <span class="muted">None</span>
                    {% endif %}
                </td>
                <td>{{ admin.created_at or 'Unknown' }}</td>
                <td>
                    <form method="post" action="{{ url_for('settings.manage_admins') }}" style="display: inline;" onsubmit="return confirm('Delete admin {{ admin.username }}?');">
                        <input type="hidden" name="action" value="delete">
                        <input type="hidden" name="username" value="{{ admin.username }}">
                        <button type="submit" class="secondary">Delete</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="table-empty">
        <p>No admin accounts found.</p>
    </div>
    {% endif %}
</div>

<div class="card" style="margin-top: 2rem; max-width: 560px;">
    <h3 style="margin-top: 0;">Add Administrator</h3>
    <p class="muted">Passwords are stored hashed; distribute credentials securely after creation.</p>
    <form method="post" action="{{ url_for('settings.manage_admins') }}">
        <input type="hidden" name="action" value="add">
        <label for="username">Username</label>
        <input id="username" name="username" required maxlength="120">

        <label for="password">Password</label>
        <input id="password" name="password" type="password" required>

        <label for="confirm">Confirm password</label>
        <input id="confirm" name="confirm" type="password" required>

        <label for="role">Role</label>
        <select id="role" name="role" data-role-select="add">
            {% for role in roles %}
                <option value="{{ role.name }}" data-description="{{ role.description|e }}">{{ role.label }}</option>
            {% endfor %}
        </select>
        <p class="muted" data-role-description="add" style="margin-top: 0.35rem;"></p>

        <div class="custom-permissions" data-custom-for="add" style="display: none; margin-top: 1rem;">
            <p class="muted" style="margin-top: 0;">Select the permissions granted to this custom role.</p>
            <div style="display: grid; gap: 0.5rem;">
                {% for perm in permissions %}
                <label style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="checkbox" name="custom_permissions" value="{{ perm.name }}">
                    <span>{{ perm.label }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
            <button type="submit" class="primary" style="flex: 1;">Add admin</button>
            <a class="button-link" href="{{ url_for('dashboard.dashboard') }}" style="flex: 1; justify-content: center;">Back</a>
        </div>
    </form>
</div>

<div class="card" style="margin-top: 2rem; max-width: 560px;">
    <h3 style="margin-top: 0;">Update Administrator</h3>
    <p class="muted">Change the role or custom permissions assigned to an existing administrator.</p>
    <form method="post" action="{{ url_for('settings.manage_admins') }}">
        <input type="hidden" name="action" value="update">

        <label for="edit_username">Administrator</label>
        <select id="edit_username" name="username" required>
            <option value="" disabled selected>Select an admin account</option>
            {% for admin in admins %}
                <option value="{{ admin.username }}">{{ admin.username }}</option>
            {% endfor %}
        </select>

        <label for="edit_role" style="margin-top: 1rem;">Role</label>
        <select id="edit_role" name="role" data-role-select="edit">
            {% for role in roles %}
                <option value="{{ role.name }}" data-description="{{ role.description|e }}">{{ role.label }}</option>
            {% endfor %}
        </select>
        <p class="muted" data-role-description="edit" style="margin-top: 0.35rem;"></p>

        <div class="custom-permissions" data-custom-for="edit" style="display: none; margin-top: 1rem;">
            <p class="muted" style="margin-top: 0;">Select the permissions this admin should retain.</p>
            <div style="display: grid; gap: 0.5rem;">
                {% for perm in permissions %}
                <label style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="checkbox" name="custom_permissions" value="{{ perm.name }}">
                    <span>{{ perm.label }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div style="margin-top: 1.5rem;">
            <button type="submit" class="primary" style="width: 100%;">Update admin</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
(function () {
    const roleSelects = Array.from(document.querySelectorAll('[data-role-select]'));
    const roleMeta = {{ roles|tojson }};
    const admins = {{ admins|tojson }};

    const roleDescriptionMap = {};
    roleMeta.forEach(function (role) {
        roleDescriptionMap[role.name] = role.description;
    });

    const adminLookup = {};
    admins.forEach(function (admin) {
        adminLookup[admin.username] = admin;
    });

    function applyRoleDescription(select) {
        const target = select.getAttribute('data-role-select');
        const descriptionEl = document.querySelector('[data-role-description="' + target + '"]');
        if (!descriptionEl) return;
        descriptionEl.textContent = roleDescriptionMap[select.value] || '';
    }

    function toggleCustomPermissions(select, preset) {
        const target = select.getAttribute('data-role-select');
        const container = document.querySelector('[data-custom-for="' + target + '"]');
        if (!container) return;

        const isCustom = select.value === 'custom';
        container.style.display = isCustom ? 'block' : 'none';

        const checkboxes = Array.from(container.querySelectorAll('input[type="checkbox"]'));
        if (!isCustom) {
            checkboxes.forEach(function (box) {
                box.checked = false;
            });
            return;
        }

        const selected = new Set(preset || []);
        checkboxes.forEach(function (box) {
            box.checked = selected.has(box.value);
        });
    }

    roleSelects.forEach(function (select) {
        applyRoleDescription(select);
        toggleCustomPermissions(select);
        select.addEventListener('change', function () {
            applyRoleDescription(select);
            toggleCustomPermissions(select);
        });
    });

    const editUsername = document.getElementById('edit_username');
    const editRole = document.getElementById('edit_role');
    if (editUsername && editRole) {
        editUsername.addEventListener('change', function () {
            const admin = adminLookup[editUsername.value];
            if (!admin) {
                return;
            }
            editRole.value = admin.role;
            applyRoleDescription(editRole);
            toggleCustomPermissions(editRole, admin.resolved_permissions || []);
        });
        // Ensure initial state reflects first selectable admin if pre-selected by browser
        if (editUsername.value && adminLookup[editUsername.value]) {
            editRole.value = adminLookup[editUsername.value].role;
            applyRoleDescription(editRole);
            toggleCustomPermissions(editRole, adminLookup[editUsername.value].resolved_permissions || []);
        }
    }
})();
</script>
{% endblock %}

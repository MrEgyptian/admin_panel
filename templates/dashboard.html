{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block content %}
<div class="card app-card shadow-sm">
	<div class="card-body">
		<div class="app-page-head">
			<div>
				<h2 class="mb-1">Executables</h2>
				<p class="muted">Manage availability, expiry, and distribution links.</p>
			</div>
			{% if can_manage_executables %}
			<a class="btn btn-primary" href="{{ url_for('dashboard.new_executable') }}">
				<i class="fa-solid fa-plus me-1"></i>Add executable
			</a>
			{% endif %}
		</div>

		{% if executables %}
		<div class="table-responsive">
			<table class="table table-hover align-middle">
				<thead class="table-light">
					<tr>
						<th scope="col">Name</th>
						<th scope="col">Type</th>
						<th scope="col">Status</th>
						<th scope="col">Available</th>
						<th scope="col">Expires</th>
						<th scope="col">Server URL</th>
						<th scope="col" class="text-end">Actions</th>
					</tr>
				</thead>
				<tbody>
				{% for exe in executables %}
					<tr>
						<td>{{ exe.name }}</td>
						<td>{{ exe.type|upper }}</td>
						<td class="badge-space">
							{% set badge_class = 'bg-success-subtle text-success' %}
							{% if exe.status_label == 'Expired' %}
								{% set badge_class = 'bg-danger-subtle text-danger' %}
							{% elif exe.status_label == 'Revoked' %}
								{% set badge_class = 'bg-secondary-subtle text-secondary' %}
							{% elif exe.status_label == 'Scheduled' %}
								{% set badge_class = 'bg-info-subtle text-info' %}
							{% endif %}
							<span class="badge rounded-pill app-badge {{ badge_class }}">{{ exe.status_label }}</span>
							{% if exe.days_remaining is not none %}
								<div class="muted">{{ exe.days_remaining }} days remaining</div>
							{% endif %}
						</td>
						<td>{{ exe.available_from or 'Immediate' }}</td>
						<td>{{ exe.expiry_date or 'No expiry' }}</td>
						<td>{{ exe.server_url or 'Not set' }}</td>
						<td class="text-end actions">
							<a class="btn btn-outline-primary btn-sm" href="{{ url_for('dashboard.download_executable', exe_id=exe.id) }}">
								<i class="fa-solid fa-download me-1"></i>Download
							</a>
							<button type="button" class="btn btn-outline-secondary btn-sm ms-1" data-copy="{{ url_for('dashboard.download_executable', exe_id=exe.id, _external=True) }}">
								<i class="fa-solid fa-link me-1"></i>Copy link
							</button>
							{% if can_manage_executables %}
							<a class="btn btn-outline-secondary btn-sm ms-1" href="{{ url_for('dashboard.edit_executable', exe_id=exe.id) }}">
								<i class="fa-solid fa-pen-to-square me-1"></i>Edit
							</a>
							<form class="d-inline" method="post" action="{{ url_for('dashboard.toggle_executable', exe_id=exe.id) }}">
								<button type="submit" class="btn btn-sm btn-warning ms-1">
									<i class="fa-solid fa-ban me-1"></i>{{ 'Unrevoke' if exe.revoked else 'Revoke' }}
								</button>
							</form>
							<form class="d-inline" method="post" action="{{ url_for('dashboard.delete_executable', exe_id=exe.id) }}" onsubmit="return confirm('Delete this executable?');">
								<button type="submit" class="btn btn-sm btn-outline-danger ms-1">
									<i class="fa-solid fa-trash-can me-1"></i>Delete
								</button>
							</form>
							{% endif %}
						</td>
					</tr>
				{% endfor %}
				</tbody>
			</table>
		</div>
		{% else %}
			<div class="table-empty">
				<p class="mb-0">No executables found. Use the button above to create one.</p>
			</div>
		{% endif %}
	</div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
	const copyButtons = document.querySelectorAll('[data-copy]');
	if (!copyButtons.length) {
		return;
	}

	copyButtons.forEach((button) => {
		if (!button.dataset.defaultHtml) {
			button.dataset.defaultHtml = button.innerHTML;
		}
		button.addEventListener('click', async () => {
			const link = button.getAttribute('data-copy');
			if (!link) {
				return;
			}

			let copied = false;
			if (navigator.clipboard && navigator.clipboard.writeText) {
				try {
					await navigator.clipboard.writeText(link);
					copied = true;
				} catch (error) {
					copied = false;
				}
			}

			if (!copied) {
				window.prompt('Copy the executable download link:', link);
			}

			button.innerHTML = copied
				? '<i class="fa-solid fa-check me-1"></i>Copied'
				: '<i class="fa-solid fa-link me-1"></i>Link ready';
			button.disabled = true;
			setTimeout(() => {
				button.innerHTML = button.dataset.defaultHtml;
				button.disabled = false;
			}, 2000);
		});
	});
});
</script>
{% endblock %}
